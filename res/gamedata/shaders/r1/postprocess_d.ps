#include "common.h"
#include "common_iostructs.h"

uniform sampler2D 	s_base0;
uniform sampler2D 	s_base1;
uniform sampler2D 	s_noise;
uniform sampler2D 	s_distort;
uniform sampler2D 	s_intensity;
uniform sampler2D 	s_grad0;
uniform half4 		c_brightness;

//////////////////////////////////////////////////////////////////////////////////////////
// Pixel
half4 	main_ps_1_4	( p_postpr I )	: COLOR
{
	half4 	distort	= tex2D		(s_distort, I.Tex0);
	half2	offset	= (distort.xy-.5h)*def_distort;
	half3	t_0 	= tex2D		(s_base0,I.Tex0+ offset);
	half3	t_1 	= tex2D		(s_base1,I.Tex1+ offset);	
	half3 	image	= (t_0+t_1)*.5;					// add_d2

	half	gray 	= dot		(image,I.Gray);			// dp3
			image 	= lerp 		(gray,image,I.Gray.w);		// mul/mad

	half4	t_noise	= tex2D		(s_noise,I.Tex2);	
	half3 	noised 	= image*t_noise*2;                     		// mul_2x
			image	= lerp 		(noised,image,I.Color.w); 	// lrp ?
			image	= (image * I.Color + c_brightness)*2;		// mad
//			image	= (image + c_brightness) * I.Color;		// mad ?

	return  half4	(image,1);					// +mov
}
